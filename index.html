<!DOCTYPE html>
<html>
<head>
	<title>GAsp_v3</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./css/index.css">
	<script type="text/javascript" src="./js/lib/ganja.js/ganja.js"></script>
	<script type="text/javascript" src="./js/classes.js"></script>	
	<script type="text/javascript" src="./js/codeInstance.js"></script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
</head>
<body>
	<nav id="nav">
		<i id="home" class="fas fa-home"></i>
		<h1>GAsp <span>a web GA manipulator</span></h1>
		<div id="controlButtons">
			<i class="fas fa-expand fa-lg" id="presentationMode" title="Presentation mode"></i>
			<div class="buttons">Save</div>
			<div id="clear" class="buttons">Clear</div>
		</div>
	</nav>
	<section id="mainPart">
		<div id="leftPanel">
			<div id="leftContent">
				<div id="consoleMode" class="active">
					<div class="selectLeftPan">
						<p class="selectMode active">Console Mode</p>
					</div>
					<div id="console"></div>
				</div>
				<div id="macros">
						<div id="movableUp" class="resize"></div>
					<div class="selectLeftPan" id="headerMacro">
						<p>GA infos</p>
					</div>
					<div id="macrosContent">
					</div>
				</div>
			</div>
			<div id="movableLeft" class="resize"></div>
		</div>
		<div id="viewerPanel">
				<div id="viewerSettings">
					<i class="fas fa-camera fa-lg"></i>
					<!--
					<i class="fas fa-th fa-lg optionSetting" data-val="grid"></i>
					<i class="fas fa-film fa-lg optionSetting" data-val="animate"></i>
					-->
				</div>
			<div id="viewer">
				<div id="projInfos">
					<h3 id="projName" class="bold">---</h3>
					<p>by <span id="projAuthor" class="bold">_____</span></p>
				</div>
				<iframe id="exampleView" class="active transi"></iframe>
				<!--<div id="newProject">
					<div id="npSub">	
						<img src="./media/img/new-document.png">
						<p>Create a new project</p>
					</div>
				</div>-->
				<div id="examples" class="transi">
					<div id="run">Run</div>
					<div id="headerExample" class="selectLeftPan">
						<p>Choose an example</p>
					</div>
					<div id="allEx"></div>
				</div>
			</div>
		</div>
	</section>
	<section id="pop-up_black">
		<div id="pop-up">
			<div id="save_header">
			</div>
			<div id="sign_in">
				<p>Sign in</p>
				<form>
					<p>
						<label>username : </label>
						<input type="email" name="email" id="userIn"/>
					</p>
					<p>
						<label>password : </label>
						<input type="password" name="password"  id="passwordIn"/>
					</p>
				</form>
			</div>
			<div id="sign_up">
				<p>Sign out</p>
				<form>
					<p>
						<label>email : </label>
						<input type="email" name="email" id="emailUp"/>
					</p>
					<p>
						<label>username : </label>
						<input type="text" name="username"  id="userUp"/>
					</p>
					<p>
						<label>password : </label>
						<input type="password" name="password"  id="passUp"/>
					</p>
					<p>
						<label>confirm password : </label>
						<input type="password" name="confirm_password"  id="confPassUp"/>
					</p>
				</form>
			</div>
			</form>
			<div class="buttons" id="sign_in_send">
				<p>OK</p>
			</div>
			<div class="buttons" id="sign_up_send">
				<p>OK</p>
			</div>
			<div id="errorForm"></div>
		</div>
	</section>
	<script src="./js/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" id="ganjaCode"></script>
	<script>
		var transitionTime = 800;
		var macroDeploy = false;
		var exampleList = ["complex_mandelbrot","complex_least_squares",
                    "dual_differentiation","dual_backpropagation",
                    "quaternion_hue","quaternion_mandelbrot",
                    "timespace_lorentz",
                    "pga2d_points_and_lines","pga2d_distances_and_angles","pga2d_project_and_reject","pga2d_rotors_and_translators","pga2d_isometries", "pga2d_inverse_kinematics","pga2d_separating_axis","pga2d_pose_estimation","pga2d_euler_line","pga2d_desargues_theorem","pga2d_differentiation","pga2d_physics_moon","pga2d_origami", "pga2d_poncelet",
                    "pga3d_points_and_lines","pga3d_distances_and_angles","pga3d_rotors_and_translators","pga3d_icosahedron","pga3d_sampling","pga3d_slicing","pga3d_differentiation","pga3d_skinning","pga3d_physics_planets","pga3d_origami","pga3d_physics_symmetric_top","pga3d_physics_free_top","pga3d_objects","pga3d_levenberg_marquardt",
                    "cga2d_points_and_circles","cga2d_project_and_reject","cga2d_rotors_and_translators","cga2d_euler_line",
                    "cga3d_points_circles_lines","cga3d_points_spheres_planes","cga3d_dual_spheres_planes","cga3d_intersections","cga3d_project_reject","cga3d_opns_visualizer","cga3d_opns_line_circle","cga3d_json",
                    "mga3d_points_and_lines",
                    "ccga3d_points_quadrics",
                    "qcga3d_points_and_more",
                    "game_wedge"];
				
		// build an array (exampleCategories) with the names of the categories, and their occurrences
		// example : ["Complex", 2, "Differentiation", 2,... ]
		var exampleCategories=[];
		var cut=exampleList[0].indexOf("_");
		var lastCat=exampleList[0].slice(0, cut);
		var occ=1;
		for(var i=1; i< exampleList.length; i ++){
			var cut=exampleList[i].indexOf("_");
			var currentCat=exampleList[i].slice(0, cut);
			if(currentCat==lastCat)
				occ ++;
			else{
				exampleCategories.push(lastCat);
				exampleCategories.push(occ);
				lastCat=currentCat;
				occ=1;
			}
		}
		exampleCategories.push(lastCat);
		exampleCategories.push(occ);
		
		
		var currentInfos = {
			"algebra": [],
			"options":{
				"grid": "false",
				"animate": "true",
				"camera": false
			}
		}
		var currentScript;
		var currentMode = 1; // 0 = project Mode | 1 = Example Mode 
		var test;
		// Elements.
   		var els={};
    	["#viewer","#viewerPanel","#run","#ganjaCode","#consoleMode","#objectMode","#console","#movableLeft","#movableUp","#leftPanel","#macros","#nav","#headerMacro","#presentationMode","#exampleView","#macrosContent","#headerExample","#allEx","#examples","#projName","#projAuthor","#clear","#sign_up_send","#errorForm"].forEach(x=>els[x.replace(/[.#]/g,'')]=document.querySelector(x));
   		var elsClass={};
    	[".selectMode",".optionSetting"].forEach(x=>elsClass[x.replace(/[.]/g,'')]=document.querySelectorAll(x));

		//ACE EDITOR (CONSOLE)
		aceEditor = () => {
			if (window.ace) {
			    var editor = ace.edit("console");
			    editor.setAutoScrollEditorIntoView(true);
			    editor.setTheme("ace/theme/tomorrow"); //theme setters 
			    editor.session.setMode("ace/mode/javascript"); //mode = js, php etc...
		     	editor.resize();
		     	return editor;
		    } else { // can't load ace editor
		      	console.log("Can't load Ace editor");
		    }
		}
		editor = aceEditor();
	    editor.setValue(""); //Fill the editor with current ganja code
	    sizeCanvas = () => {
		//CANVAS SIZE
		    var present = els.exampleView.contentDocument.querySelector("svg")||els.exampleView.contentDocument.querySelector("canvas");
		   	if(present == null)
		   		return;
		    if (present || present.value){ 
		    	present.width= els.exampleView.offsetWidth; 
		    	present.height = els.exampleView.offsetHeight;
		    	present.style.width= "100%";
		    	present.style.height = "100%";	
		    }
		};
		changeActive = (element) =>{
			element.classList.toggle("active");
		}
		updateViewer = () =>{
			var currentCode = editor.getValue();
			var parent = currentScript.parentNode;
			parent.innerHTML = '';
			var script= document.createElement('script');
     		script.innerHTML = currentCode;
     		parent.appendChild(script);
     		currentScript = script;
			sizeCanvas();
			changeActive(els.run);
		}
		refreshConsole = (code) => {
			editor.setValue(code);
		}
		refreshOption = () => {
			for(var i = 0; i<elsClass.optionSetting.length; i++){
				var div = elsClass.optionSetting[i];
				var data = div.dataset.val;
				if(data in currentInfos["options"]){
					if(currentInfos["options"][data] === "true" || currentInfos["options"][data] === true){
						div.classList.add("active");
					}
				}
			}
		}

		loadProjInfos = (author, name) =>{
			els.projName.innerHTML = name;
			els.projAuthor.innerHTML = author;
		}
		loadExample = (name) =>{
			loadProjInfos("ganja.js master",name);
        	els.exampleView.setAttribute("src", "./js/lib/ganja.js/examples/example_"+name+".html");
		}
		displayExample = () => {
			var k=0;
			for(var j=0; j<exampleCategories.length; j+=2){
				var exampleCat = document.createElement("div");
				exampleCat.classList.add("exampleCat");
				var titleCat = document.createElement("p");
				titleCat.innerHTML=exampleCategories[j];
				titleCat.setAttribute("class", "exTitles");
				els.allEx.appendChild(titleCat);
				for(var i = 0; i<Number(exampleCategories[j+1]); i++){
	//				els.allEx.innerHTML += "<p onclick='loadExample(\""+exampleList[i]+"\")'>"+exampleList[i]+"</p>";
					var example = document.createElement("div");
					var imageEx = document.createElement("img");
					imageEx.setAttribute("title", exampleList[k]);
					imageEx.setAttribute("src", "./js/lib/ganja.js/images/"+exampleList[k]+".jpg");
					imageEx.setAttribute("onclick", "loadExample('"+exampleList[k]+"')");
					example.appendChild(imageEx);
					var titleEx = document.createElement("p");
					titleEx.innerHTML=exampleList[k].split('_').slice(1).join(' ');
					example.appendChild(titleEx);
					exampleCat.appendChild(example);
					k++;
				}
				els.allEx.appendChild(exampleCat);
			}
		}

		//Function that loads the different necessary parts/div of the current Mode
		displayInterface = () => {
			switch(currentMode){
				case 0:
					els.run.style.top = '-10px';
					break;
				case 1: 
					els.clear.style.display = 'none';
					els.headerExample.style.display = 'flex';
					els.allEx.style.display = 'block';
					loadExample("pga3d_icosahedron");
					break;
			}
		}
		preloadIframe = () =>{
	      	els.exampleView.contentDocument.body.style = "margin:0; padding:0;width:100%; height:100%; margin:0;";
	      	if(currentMode==0){

				//script that contains the ganja.js
	      		var currentCode = editor.getValue();
	      		var scriptGJ= document.createElement('script');
     			scriptGJ.type = "text/javascript";
     			scriptGJ.src = "./js/lib/ganja.js/ganja.js";
     			els.exampleView.contentDocument.getElementsByTagName("head")[0].appendChild(scriptGJ);

	      		//script that contains the ganja.js
	      		var currentCode = editor.getValue();
	      		var script= document.createElement('script');
     			script.innerHTML = currentCode;
     			els.exampleView.contentDocument.body.appendChild(script);
     			currentScript = script;
	      	}
	      	sizeCanvas();
/*
	      	var mystyle = document.createElement('style');
	      	mystyle.type = 'text/css';
	      	mystyle.innerHTML = 'svg,canvas{width:100%;height:100%;}';
	      	els.exampleView.contentDocument.getElementsByTagName("head")[0].appendChild(mystyle);*/
		}
		takeScreenShot = () =>{
			var canvas = els.exampleView.contentDocument.querySelector("canvas")/* || els.exampleView.contentDocument.querySelector("svg")*/;
			var width = canvas.width;
			var height = canvas.height;
			canvas.width = 1920;
			canvas.height = 1080;

			canvas.update(canvas.value);
			//Open the screenshot in a new window
			var dataUrl = canvas.toDataURL(1);
			window.open(dataUrl, "toDataURL() image", "width=600, height=200"); //2
			canvas.width = width;
			canvas.height = height;

			canvas.update(canvas.value);
		}
		function convertCanvasToImage(canvas) {
			var image = new Image();
			image.src = canvas.toDataURL("image/png");
			return image;
		}

		cloneCanvas = (canvas) => {
		    //create a new canvas
		    var newCanvas = document.createElement('canvas');
		    var context = newCanvas.getContext('2d');

		    //set dimensions
		    newCanvas.width = canvas.width;
		    newCanvas.height = canvas.height;

		    //apply the old canvas to the new one
		    context.drawImage(canvas, 0, 0);
		    //return the new canvas
		    return newCanvas;
		}

		function signUp(){
			var mail = document.getElementById('emailUp');
			var user= document.getElementById('userUp');
			var pwd = document.getElementById('passUp');
			var confPwd = document.getElementById('confPassUp');

			if(mail.value!="" && user.value!="" && pwd.value!="" && confPwd.value!=""){
				if (/^([a-z0-9._-]+)@([a-z0-9._-]+)\.([a-z]{2,6})$/.test(mail.value)){ //Checking mail
					if(user.value.length>=5){
						if(pwd.value==confPwd.value){
							var payload = {
								email: mail.value,
								username: user.value,
								password: pwd.value
							};
							var data = new FormData();
							data.append( "json", JSON.stringify( payload ) );

							var myHeaders = new Headers({
							 	'Accept': 'application/json',
      							'Content-Type': undefined,
      							'Access-Control-Allow-Origin': '*'
							});


							fetch('https://serene-forest-42732.herokuapp.com/signup',{
								method: "POST",
								body: data,
								mode: 'cors',
								header: myHeaders
							})
							.then(function(res){return res.json();})
							.then(function(data){alert(JSON.stringify(data) ) })


						}
						else{
							els.errorForm.innerHTML = "Different password";
						}
					}
					else{
						els.errorForm.innerHTML = "Username is too short (5 characters min)";
					}
				}
				else{
					els.errorForm.innerHTML = "Invalid email";
				}
			}
			else{
				els.errorForm.innerHTML = "Missing values";
			}
		}

    /********************
    	Event Listener
   	********************/
 		//Scalable sections
		els.movableLeft.onmousedown=(e) =>{
			window.onmousemove = function(e) {
				els.presentationMode.classList.remove("active");
				//Remove the smoothing transition
				if(els.leftPanel.classList.contains("transi")){
					els.leftPanel.classList.remove("transi");
					els.viewerPanel.classList.remove("transi");
				}
				var width = document.body.clientWidth ;
				var mouseX = e.clientX;
			
					 //In case of double screen
				if(mouseX<0) mouseX = 0;
				else if(mouseX>width-4) mouseX = width-4;	 
				var pourc = ((mouseX)*100)/width;
				els.leftPanel.style.width = pourc+"%";
				els.viewerPanel.style.width = (100-pourc)+"%";
				els.viewerPanel.style.marginLeft = pourc+"%";
				editor.resize();
				sizeCanvas();
			}
			window.onmouseleave = window.onmouseup = function(e) { window.onmouseleave = window.onmouseup = window.onmousemove = undefined; };
		}
		els.movableUp.onmousedown=(e) =>{
			window.onmousemove = function(e) {
				macroDeploy = true;
				//Remove the smoothing transition
				if(els.consoleMode.classList.contains("transi")){
					els.consoleMode.classList.remove("transi");
					els.macros.classList.remove("transi");
				}
				var height = els.leftPanel.offsetHeight;
				var mouseY = e.clientY;
				if(mouseY-els.nav.offsetHeight > els.leftPanel.offsetHeight-50 ){
					mouseY = els.leftPanel.offsetHeight+20; //Definitly not a magic number, will come back to it later
					macroDeploy = false;
				}
				if(mouseY-els.nav.offsetHeight < 50)
					mouseY = 50;
				
				var pourc = ((mouseY-els.nav.offsetHeight)*100)/height;

				els.consoleMode.style.height = pourc+"%";
				els.macros.style.height = (100-pourc)+"%";
				editor.resize();
			}
			window.onmouseleave = window.onmouseup = function(e) { window.onmouseleave = window.onmouseup = window.onmousemove = undefined; };
		}
		els.headerMacro.onclick = (e) => {
			if(!macroDeploy){
				els.consoleMode.classList.add("transi");
				els.macros.classList.add("transi");
				els.consoleMode.style.height = "60%";
				els.macros.style.height = "40%";
				macroDeploy = true;
			}
			else{
				els.consoleMode.classList.add("transi");
				els.macros.classList.add("transi");
				els.consoleMode.style.height = "calc(100% - 50px)";
				els.macros.style.height = "50px";
				macroDeploy = false;
			}
		}
		//Presentation Mode
		els.presentationMode.onclick = (e) =>{
			changeActive(els.presentationMode);
			if(els.presentationMode.classList.contains("active")){
				els.leftPanel.classList.add("transi");
				els.viewerPanel.classList.add("transi");
				els.leftPanel.style.width = els.viewerPanel.style.marginLeft = "0%";
				els.viewerPanel.style.width = "100%";
			}
			else{
				els.leftPanel.classList.add("transi");
				els.viewerPanel.classList.add("transi");
				els.leftPanel.style.width = els.viewerPanel.style.marginLeft = "40%";
				els.viewerPanel.style.width = "60%";
			}
		}
		els.headerExample.onclick = (e) =>{
			changeActive(els.examples);
			changeActive(els.exampleView);
			if(els.allEx.innerHTML == '')
				displayExample();
			setTimeout(function(){ sizeCanvas(); }, transitionTime);
		}
		for(var i = 0; i<elsClass.optionSetting.length; i++){
			elsClass.optionSetting[i].onclick = (function (i){
				return function (){
					changeActive(elsClass.optionSetting[i]);
					//Changing currentInfos param
					var data = elsClass.optionSetting[i].dataset.val;
					if(elsClass.optionSetting[i].classList.contains("active")){
						currentInfos["options"][data] === "false" ? currentInfos["options"][data] = "true" : currentInfos["options"][data] = true;
					}
					else{
						currentInfos["options"][data] === "true" ? currentInfos["options"][data] = "false" : currentInfos["options"][data] = false;
					}
					console.log(data + "   " + currentInfos["options"][data] + "   " + typeof currentInfos["options"][data]);
					//changing the options of the current instance
					inst.setOption(data, currentInfos["options"][data]);
					refreshConsole();
					updateViewer();
				}
			})(i);
		}

		els.sign_up_send.onclick = (e) =>{
			signUp();
		}

		//Iframe loading
		els.exampleView.onload = (e)=>{
			preloadIframe();
	      	
	      	//Taking the script of the example
	      	currentScript = [...els.exampleView.contentDocument.querySelectorAll("script")].pop();
	      	refreshConsole(currentScript.innerText);
	    }

		//EVENTS LISTENER ON CONSOLE 
	    editor.session.on('change', function(delta) {
			// delta.start, delta.end, delta.lines, delta.action
			if(delta.action=="insert" || delta.action=="remove"){
				els.run.classList.add("active");
			}
		});

		//EVENT CLICK RUN 
		document.getElementById("run").onclick=() =>{
			updateViewer();
		}
		
		//EVENT CLICK CLEAR
		els.clear.onclick=() =>{
			editor.setValue("");
			updateViewer();
		}
		

	    refreshOption();
	    displayInterface();
	    preloadIframe();
		
	</script>
</body>
</html>
