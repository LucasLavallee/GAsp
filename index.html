<!DOCTYPE html>
<html>
<head>
	<title>GAsp_v3</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./css/index.css">

	<script type="text/javascript" src="./js/lib/ganja.js/ganja.js/"></script>
	<script type="text/javascript" src="./js/classes.js"></script>	
	<script type="text/javascript" src="./js/codeInstance.js"></script>
</head>
<body>
	<nav>
		<h1>GAsp <span>a web GA manipulator</span></h1>
	</nav>
	<!-- -->
	<section id="mainPart">
		<div id="leftPanel">
			<div id="selectLeftPan">

				<p class="selectMode active">Console Mode</p>
				<p class="selectMode">Object Mode</p>
			</div>
			<div id="leftContent">
				<div id="consoleMode" class="active">
					<div id="headerCMode">
						<p>JS</p>
						<p>Pseudo-code</p>
					</div>
					<div id="console"></div>
				</div>
				<div id="objectMode">
					<p>Welcome to the object mode</p>
				</div>
			</div>
		</div>
		<div id="viewer">
			<!--<div id="newProject">
				<div id="npSub">	
					<img src="./media/img/new-document.png">
					<p>Create a new project</p>
				</div>
			</div>-->	

		</div>
		<div id="run">Run</div>
	</section>
	<script src="./js/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" id="ganjaCode"></script>
	<script>
		// Elements.
   		var els={};
    	["#viewer","#run","#ganjaCode","#consoleMode","#objectMode","#console"].forEach(x=>els[x.replace(/[.#]/g,'')]=document.querySelector(x));
   		var elsClass={};
    	[".selectMode"].forEach(x=>elsClass[x.replace(/[.]/g,'')]=document.querySelectorAll(x));

    	console.log(els.selectMode);
		//ACE EDITOR (CONSOLE)
		aceEditor = () => {
			if (window.ace) {
			    var editor = ace.edit("console");
			    editor.setTheme("ace/theme/tomorrow"); //theme setters 
			    editor.session.setMode("ace/mode/javascript"); //mode = js, php etc...
		     	editor.resize();
		     	return editor;
		    } else { // can't load ace editor
		      	console.log("Can't load Ace editor");
		    }
		}
		editor = aceEditor();
	    editor.setValue(""); //Fill the editor with current ganja code


	    sizeCanvas = () => {
		//CANVAS SIZE
			
		    var present = els.viewer.querySelector("svg")||els.viewer.querySelector("canvas");
		   	if(present == null)
		   		return;
		    if (present || present.value){ 
		    	present.style.width= "100%";  	
		    	present.style.height = document.getElementById("leftPanel").offsetHeight+"px";
		    }
		};

	    //Event Listener

		/*document.getElementById("newProject").onclick = () =>{
			modalCreate.display();
		}*/

		for (var i = 0; i < elsClass.selectMode.length; i++) {
		    elsClass.selectMode[i].onclick = () =>{
		    	changeActive(elsClass.selectMode[0]);
		    	changeActive(elsClass.selectMode[1]);
		    	changeActive(els.consoleMode);
		    	changeActive(els.objectMode);
		    }
		}

		changeActive = (element) =>{
			element.classList.toggle("active");
		}

		//EVENTS LISTENER ON CONSOLE 
	    editor.session.on('change', function(delta) {
			// delta.start, delta.end, delta.lines, delta.action
			if(delta.action=="insert" || delta.action=="remove"){
				els.run.classList.add("active");
			}
		});


		//EVENT CLICK RUN 
		document.getElementById("run").onclick=() =>{
			var currentCode = editor.getValue();
			els.viewer.innerHTML = "";
			var scriptGJ = document.getElementById("ganjaCode");
			scriptGJ.parentNode.removeChild(scriptGJ);
			var script= document.createElement('script');
     		script.id= 'ganjaCode';
     		script.innerHTML = currentCode;
     		document.body.appendChild(script);
			document.getElementById("run").classList.remove("active");
			sizeCanvas();
		}

	    //Modals Creation

	    const modalCreate = new Modal("Create a project");
	    modalCreate.content = "<form method='post' action=''><label for='name'>Project Name (20 characters MAX): </label><input type='text' name='name'><label for='ga'>Project description: </label><textarea></textarea><label for='ga'>Select your GA: </label><select name='ga'><option>GA 1</option></select></form>";
	    modalCreate.footer = "<input type='submit' value='Create'>";


	    var inst = new CodeInstance([3,0,1]);
	    //Object.freeze(inst);

	    inst.addDefinition("//DEFINITION PART");
	    inst.addDefinition("var point = (x,y,z)=>1e123-x*1e012+y*1e013+z*1e023;");
	    inst.addDefinition("var line = (px,py,pz,dx,dy,dz)=>px*1e01+py&1e02+pz*1e03+dx*1e12+dy*1e13+dz*1e23;");
	    inst.addDefinition("var plane = (a,b,c,d)=>d*1e0+a*1e1+b*1e2+c*1e3;");
	    inst.addDefinition("var dist_pp = (P1,P2)=>(P1.Normalized&P2.Normalized).Length,");
	    inst.addDefinition("dist_pP = (P,p)=>(P.Normalized&p.Normalized).Length,");
	    inst.addDefinition("dist_ll = (l1,l2)=>(!(l1.Normalized*l2.Normalized)).Length;");
	    inst.addDefinition("var angle_pp = (p1,p2)=>Math.acos(p1.Normalized<<p2.Normalized)*180/Math.PI,");
	    inst.addDefinition("angle_ll = (l1,l2)=>Math.acos(l1.Normalized<<l2.Normalized)*180/Math.PI;");

	    inst.addObject("//CREATION PART");
		inst.addObject("var A=point(0,-1,0), B=point(1,1,-1), C=point(-1,1,-1), D=point(1,1,1), E=point(-1,1,1),");
		inst.addObject("a=B&C&D,");
		inst.addObject("camera=0e0;");

		inst.addDisplay("//DISPLAY PART");
		inst.addDisplay("var time=performance.now()/4000;");
		inst.addDisplay("A=point(0,Math.sin(time*4),0);");
		inst.addDisplay("camera.set(Math.cos(time)+Math.sin(time)*1e13);");
		inst.addDisplay("return [0xddaaff,[A,B,C],");
		inst.addDisplay("0xAA88FF,[A,B],[A,C],[A,D],[B,C],[B,D],[C,E],[A,E],[E,D],");
		inst.addDisplay("0x444444,A,'A',B,'B',C,'C',D,'D',E,'E',");
		inst.addDisplay("0xFF8888,[A,E],dist_pp(A,E).toFixed(2),");
		inst.addDisplay("0x8888FF,[A,B+E],dist_pP(A,a).toFixed(2),");
		inst.addDisplay("0x44aa44,C+E,dist_ll(C&E,D&B).toFixed(2),");
		inst.addDisplay("0x44aaff,[A+D+E,B+C+5*D+5*E,D+E],(angle_pp(A&E&D,a).toFixed(2))+'°',");
		inst.addDisplay("0xff44ff,[A,2*A+D,2*A+B],(angle_ll(A&D,B&A).toFixed(2))+'°'];"); 

		inst.addOption("animate", "true");
		inst.addOption("camera", false);

	    var code = inst.displayAll();
	    console.log(code);
	    editor.setValue(code);
	</script>
</body>
</html>